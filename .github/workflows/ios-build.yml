name: Build iOS App (Free Mac Runner)

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build-ios:
    runs-on: macos-latest  # FREE Mac runner from GitHub!
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm install
      
      - name: Update Expo packages
        run: |
          echo "Updating Expo packages to ensure compatibility..."
          npx expo install --fix
          npx expo install expo expo-modules-core
      
      - name: Generate native project
        run: npx expo prebuild --platform ios --clean
      
      - name: Fix Podfile for Xcode 16.4 compatibility
        run: |
          echo "=== Fixing Podfile for Expo modules compatibility ==="
          cd ios
          
          # Check if Podfile exists
          if [ ! -f "Podfile" ]; then
            echo "ERROR: Podfile not found after prebuild!"
            exit 1
          fi
          
          # Create backup
          cp Podfile Podfile.backup
          
          # Check if post_install already exists and remove it
          if grep -q "post_install" Podfile; then
            echo "⚠️  post_install block already exists, removing it..."
            # Use Python to remove post_install block more reliably
            echo 'import re' > remove_post_install.py
            echo '' >> remove_post_install.py
            echo 'with open("Podfile", "r") as f:' >> remove_post_install.py
            echo '    lines = f.readlines()' >> remove_post_install.py
            echo '' >> remove_post_install.py
            echo 'in_post_install = False' >> remove_post_install.py
            echo 'end_count = 0' >> remove_post_install.py
            echo 'result_lines = []' >> remove_post_install.py
            echo '' >> remove_post_install.py
            echo 'for i, line in enumerate(lines):' >> remove_post_install.py
            echo '    if re.search(r"post_install\s+do\s*\|", line):' >> remove_post_install.py
            echo '        in_post_install = True' >> remove_post_install.py
            echo '        end_count = 0' >> remove_post_install.py
            echo '        continue' >> remove_post_install.py
            echo '' >> remove_post_install.py
            echo '    if in_post_install:' >> remove_post_install.py
            echo '        stripped = line.strip()' >> remove_post_install.py
            echo '        if stripped == "end":' >> remove_post_install.py
            echo '            end_count += 1' >> remove_post_install.py
            echo '            if end_count == 1:' >> remove_post_install.py
            echo '                in_post_install = False' >> remove_post_install.py
            echo '                continue' >> remove_post_install.py
            echo '        continue' >> remove_post_install.py
            echo '' >> remove_post_install.py
            echo '    result_lines.append(line)' >> remove_post_install.py
            echo '' >> remove_post_install.py
            echo 'with open("Podfile", "w") as f:' >> remove_post_install.py
            echo '    f.writelines(result_lines)' >> remove_post_install.py
            python3 remove_post_install.py
            rm remove_post_install.py
          fi
          
          # Validate Podfile syntax before proceeding
          echo "Validating Podfile syntax..."
          if ! ruby -c Podfile 2>/dev/null; then
            echo "⚠️  Podfile syntax check failed, but continuing..."
          else
            echo "✅ Podfile syntax is valid"
          fi
          
          # Add Swift version and nullability fixes
          echo '' >> Podfile
          echo '# Post-install fixes for Expo modules and Xcode 16.4 compatibility' >> Podfile
          echo 'post_install do |installer|' >> Podfile
          echo '  installer.pods_project.targets.each do |target|' >> Podfile
          echo '    target.build_configurations.each do |config|' >> Podfile
          echo '      # Set Swift version to 5.0 (compatible with Xcode 16.4)' >> Podfile
          echo "      config.build_settings['SWIFT_VERSION'] = '5.0'" >> Podfile
          echo '' >> Podfile
          echo '      # Fix nullability warnings in Expo modules' >> Podfile
          echo "      config.build_settings['GCC_WARN_INHIBIT_ALL_WARNINGS'] = 'YES'" >> Podfile
          echo "      config.build_settings['CLANG_WARN_QUOTED_INCLUDE_IN_FRAMEWORK_HEADER'] = 'NO'" >> Podfile
          echo '' >> Podfile
          echo '      # Ensure proper deployment target' >> Podfile
          echo '      deployment_target = config.build_settings['"'"'IPHONEOS_DEPLOYMENT_TARGET'"'"']' >> Podfile
          echo '      if deployment_target.nil? || deployment_target.to_f < 18.5' >> Podfile
          echo "        config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '18.5'" >> Podfile
          echo '      end' >> Podfile
          echo '' >> Podfile
          echo '      # Fix for Objective-C++ compilation' >> Podfile
          echo "      config.build_settings['CLANG_CXX_LANGUAGE_STANDARD'] = 'c++17'" >> Podfile
          echo "      config.build_settings['CLANG_CXX_LIBRARY'] = 'libc++'" >> Podfile
          echo '    end' >> Podfile
          echo '  end' >> Podfile
          echo 'end' >> Podfile
          
          # Validate Podfile syntax after modification
          echo ""
          echo "Validating Podfile syntax after modification..."
          if ruby -c Podfile; then
            echo "✅ Podfile syntax is valid"
          else
            echo "❌ ERROR: Podfile syntax is invalid!"
            echo "Podfile content (last 30 lines):"
            tail -30 Podfile
            exit 1
          fi
          
          echo ""
          echo "✅ Podfile updated with compatibility fixes"
          echo "Added fixes:"
          echo "- Swift version 5.0"
          echo "- Nullability warning suppressions"
          echo "- C++17 standard for Objective-C++"
          echo "- iOS 18.5 deployment target"
          echo ""
          echo "Podfile preview (last 20 lines):"
          tail -20 Podfile
          cd ..
      
      - name: Clean and install CocoaPods
        run: |
          echo "=== Cleaning and installing CocoaPods ==="
          cd ios
          
          # Clean previous builds
          rm -rf Pods Podfile.lock
          rm -rf ~/Library/Developer/Xcode/DerivedData/*
          
          # Update CocoaPods repo
          pod repo update || true
          
          # Install pods
          pod install --repo-update
          
          echo "✅ CocoaPods installed successfully"
          cd ..
      
      - name: Setup Xcode
        run: |
          sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          xcodebuild -version
          echo ""
          echo "Xcode SDK paths:"
          xcrun --show-sdk-path --sdk iphoneos || true
          xcrun --show-sdk-path --sdk iphonesimulator || true
      
      - name: Setup Xcode Signing (Free Apple ID)
        run: |
          # Xcode will use automatic signing with free Apple ID
          # This requires manual setup in Xcode, but we'll try automatic
          echo "Setting up automatic code signing..."
      
      - name: Create build directory
        run: mkdir -p build
      
      - name: List iOS project structure
        run: |
          echo "=== iOS Project Structure ==="
          ls -la ios/ || echo "ios/ directory not found"
          ls -la ios/*.xcworkspace 2>/dev/null || echo "No .xcworkspace found"
          ls -la ios/*.xcodeproj 2>/dev/null || echo "No .xcodeproj found"
      
      - name: Discover scheme name
        id: scheme
        run: |
          echo "=== Discovering Scheme Name ==="
          # Try to find workspace first
          WORKSPACE=$(find ios -name "*.xcworkspace" -type d | head -n 1)
          if [ -z "$WORKSPACE" ]; then
            # Fall back to xcodeproj
            PROJECT=$(find ios -name "*.xcodeproj" -type d | head -n 1)
            if [ -z "$PROJECT" ]; then
              echo "ERROR: No workspace or project found!"
              exit 1
            fi
            echo "Found project: $PROJECT"
            SCHEME=$(xcodebuild -list -project "$PROJECT" | grep -A 100 "Schemes:" | grep -v "Schemes:" | head -n 1 | xargs)
          else
            echo "Found workspace: $WORKSPACE"
            SCHEME=$(xcodebuild -list -workspace "$WORKSPACE" | grep -A 100 "Schemes:" | grep -v "Schemes:" | head -n 1 | xargs)
          fi
          
          if [ -z "$SCHEME" ]; then
            # Default to app name from app.json
            SCHEME="WorkoutTracker"
            echo "Using default scheme: $SCHEME"
          else
            echo "Discovered scheme: $SCHEME"
          fi
          
          echo "scheme=$SCHEME" >> $GITHUB_OUTPUT
          echo "workspace=$WORKSPACE" >> $GITHUB_OUTPUT
      
      - name: Build iOS app
        run: |
          set -e  # Exit on error
          echo "=== Starting iOS Build ==="
          
          SCHEME="${{ steps.scheme.outputs.scheme }}"
          WORKSPACE="${{ steps.scheme.outputs.workspace }}"
          
          if [ -z "$WORKSPACE" ]; then
            WORKSPACE="ios/WorkoutTracker.xcworkspace"
          fi
          
          # Check if workspace exists
          if [ ! -d "$WORKSPACE" ] && [ ! -d "${WORKSPACE%.xcworkspace}.xcodeproj" ]; then
            echo "ERROR: Workspace/Project not found: $WORKSPACE"
            ls -la ios/
            exit 1
          fi
          
          echo "Building with scheme: $SCHEME"
          echo "Using workspace: $WORKSPACE"
          
          # Determine SDK path
          SDK_PATH=$(xcrun --show-sdk-path --sdk iphoneos)
          echo "Using SDK: $SDK_PATH"
          
          # Build archive - use development signing for free Apple ID
          BUILD_SUCCESS=false
          
          if [[ "$WORKSPACE" == *.xcworkspace ]]; then
            echo "Building with workspace..."
            if xcodebuild -workspace "$WORKSPACE" \
              -scheme "$SCHEME" \
              -configuration Release \
              -sdk iphoneos \
              -archivePath build/WorkoutTracker.xcarchive \
              -allowProvisioningUpdates \
              DEVELOPMENT_TEAM="" \
              CODE_SIGN_IDENTITY="Apple Development" \
              CODE_SIGN_STYLE="Automatic" \
              archive 2>&1 | tee build.log; then
              BUILD_SUCCESS=true
            else
              echo "Build with automatic signing failed, checking logs..."
              cat build.log | tail -50
              echo ""
              echo "Trying without code signing..."
              if xcodebuild -workspace "$WORKSPACE" \
                -scheme "$SCHEME" \
                -configuration Release \
                -sdk iphoneos \
                -archivePath build/WorkoutTracker.xcarchive \
                CODE_SIGN_IDENTITY="" \
                CODE_SIGNING_ALLOWED=NO \
                archive 2>&1 | tee build.log; then
                BUILD_SUCCESS=true
              fi
            fi
          else
            echo "Building with project..."
            if xcodebuild -project "${WORKSPACE%.xcworkspace}.xcodeproj" \
              -scheme "$SCHEME" \
              -configuration Release \
              -sdk iphoneos \
              -archivePath build/WorkoutTracker.xcarchive \
              -allowProvisioningUpdates \
              DEVELOPMENT_TEAM="" \
              CODE_SIGN_IDENTITY="Apple Development" \
              CODE_SIGN_STYLE="Automatic" \
              archive 2>&1 | tee build.log; then
              BUILD_SUCCESS=true
            else
              echo "Build with automatic signing failed, checking logs..."
              cat build.log | tail -50
              echo ""
              echo "Trying without code signing..."
              if xcodebuild -project "${WORKSPACE%.xcworkspace}.xcodeproj" \
                -scheme "$SCHEME" \
                -configuration Release \
                -sdk iphoneos \
                -archivePath build/WorkoutTracker.xcarchive \
                CODE_SIGN_IDENTITY="" \
                CODE_SIGNING_ALLOWED=NO \
                archive 2>&1 | tee build.log; then
                BUILD_SUCCESS=true
              fi
            fi
          fi
          
          if [ "$BUILD_SUCCESS" = false ]; then
            echo "ERROR: Build failed!"
            echo "Last 100 lines of build log:"
            tail -100 build.log || true
            exit 1
          fi
          
          echo "=== Build Complete ==="
          echo "Archive contents:"
          ls -la build/WorkoutTracker.xcarchive/ || true
          
          # Verify archive contains app bundle
          APP_BUNDLE=$(find build/WorkoutTracker.xcarchive -name "*.app" -type d | head -n 1)
          if [ -z "$APP_BUNDLE" ]; then
            echo "WARNING: No app bundle found in archive!"
            echo "Checking archive structure:"
            find build/WorkoutTracker.xcarchive -type f -o -type d | head -30
            echo ""
            echo "Checking Products directory:"
            ls -la build/WorkoutTracker.xcarchive/Products/ || true
            echo ""
            echo "Trying to find any .app files:"
            find build -name "*.app" -type d || echo "No .app files found"
            exit 1
          else
            echo "✅ Found app bundle: $APP_BUNDLE"
          fi
      
      - name: Export IPA (Development for Free Apple ID)
        run: |
          set -e  # Exit on error
          echo "=== Starting IPA Export ==="
          
          ARCHIVE_PATH="build/WorkoutTracker.xcarchive"
          
          # Verify archive exists
          if [ ! -d "$ARCHIVE_PATH" ]; then
            echo "ERROR: Archive not found!"
            ls -la build/
            exit 1
          fi
          
          # Find the app bundle in the archive
          APP_BUNDLE=$(find "$ARCHIVE_PATH" -name "*.app" -type d | head -n 1)
          if [ -z "$APP_BUNDLE" ]; then
            echo "ERROR: No app bundle found in archive!"
            echo "Archive structure:"
            find "$ARCHIVE_PATH" -type f -o -type d | head -30
            echo ""
            echo "Products directory:"
            ls -la "$ARCHIVE_PATH/Products/" || true
            exit 1
          fi
          
          APP_NAME=$(basename "$APP_BUNDLE" .app)
          echo "Found app bundle: $APP_BUNDLE"
          echo "App name: $APP_NAME"
          
          # Try xcodebuild export first (for signed builds)
          cat > exportOptions.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>development</string>
            <key>signingStyle</key>
            <string>automatic</string>
          </dict>
          </plist>
          EOF
          
          # Try xcodebuild export
          if xcodebuild -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportPath build \
            -exportOptionsPlist exportOptions.plist 2>&1 | tee export.log; then
            echo "✅ Export succeeded via xcodebuild"
          else
            echo "⚠️  xcodebuild export failed (this is OK for unsigned builds)"
            echo "Creating IPA manually from app bundle..."
            
            # Create IPA manually (works for both signed and unsigned)
            mkdir -p build/Payload
            cp -R "$APP_BUNDLE" "build/Payload/$APP_NAME.app"
            
            # Remove any existing IPA
            rm -f "build/${APP_NAME}.ipa"
            
            # Create IPA
            cd build
            zip -r "${APP_NAME}.ipa" Payload
            cd ..
            
            # Cleanup
            rm -rf build/Payload
            
            echo "✅ IPA created manually: build/${APP_NAME}.ipa"
          fi
          
          # Verify IPA was created
          echo ""
          echo "=== Export Complete ==="
          echo "Build directory contents:"
          ls -lah build/ | grep -E "\.(ipa|xcarchive)" || ls -lah build/
          
          IPA_FILE=$(find build -name "*.ipa" -type f | head -n 1)
          if [ -z "$IPA_FILE" ]; then
            echo "❌ ERROR: No IPA file found!"
            exit 1
          else
            echo "✅ IPA file found: $IPA_FILE"
            echo "File size: $(du -h "$IPA_FILE" | cut -f1)"
          fi
      
      - name: Check for IPA file
        run: |
          echo "=== Checking for IPA files ==="
          find build -name "*.ipa" -type f || echo "No IPA files found in build/"
          ls -la build/ || echo "build/ directory doesn't exist"
      
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        if: always()  # Upload even if previous steps failed
        with:
          name: ios-build
          path: |
            build/*.ipa
            build/*.xcarchive
          if-no-files-found: warn
      
      - name: Upload IPA to release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: build/*.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

