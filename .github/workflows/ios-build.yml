name: Build iOS App (Free Mac Runner)

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build-ios:
    runs-on: macos-latest  # FREE Mac runner from GitHub!
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm install
      
      - name: Check Expo compatibility
        run: |
          echo "=== Checking Expo compatibility ==="
          npx expo-doctor || echo "⚠️  expo-doctor found issues (continuing anyway)"
          echo ""
          echo "Expo version:"
          npx expo --version || true
          echo ""
          echo "React Native version:"
          npm list react-native || true
      
      - name: Update Expo packages
        run: |
          echo "=== Updating Expo packages to ensure compatibility ==="
          npx expo install --fix
          npx expo install expo expo-modules-core
      
      - name: Generate native project
        run: npx expo prebuild --platform ios --clean
      
      - name: Fix Podfile for Xcode 16.4 compatibility
        run: |
          echo "=== Fixing Podfile for Expo modules compatibility ==="
          cd ios
          
          # Check if Podfile exists
          if [ ! -f "Podfile" ]; then
            echo "ERROR: Podfile not found after prebuild!"
            exit 1
          fi
          
          # Create backup
          cp Podfile Podfile.backup
          
          # Check if post_install already exists
          if grep -q "post_install" Podfile; then
            echo "⚠️  post_install block already exists (likely from Expo/Hermes)"
            echo "Appending our fixes to existing post_install block..."
            
            # Use Python to insert our fixes INSIDE the post_install block before the final 'end'
            echo 'import re' > modify_post_install.py
            echo '' >> modify_post_install.py
            echo 'with open("Podfile", "r") as f:' >> modify_post_install.py
            echo '    lines = f.readlines()' >> modify_post_install.py
            echo '' >> modify_post_install.py
            echo 'in_post_install = False' >> modify_post_install.py
            echo 'end_count = 0' >> modify_post_install.py
            echo 'result_lines = []' >> modify_post_install.py
            echo 'inserted = False' >> modify_post_install.py
            echo '' >> modify_post_install.py
            echo 'for i, line in enumerate(lines):' >> modify_post_install.py
            echo '    if re.search(r"post_install\s+do\s*\|", line):' >> modify_post_install.py
            echo '        in_post_install = True' >> modify_post_install.py
            echo '        end_count = 0' >> modify_post_install.py
            echo '        result_lines.append(line)' >> modify_post_install.py
            echo '        continue' >> modify_post_install.py
            echo '' >> modify_post_install.py
            echo '    if in_post_install:' >> modify_post_install.py
            echo '        stripped = line.strip()' >> modify_post_install.py
            echo '        if stripped == "end":' >> modify_post_install.py
            echo '            end_count += 1' >> modify_post_install.py
            echo '            if end_count == 1 and not inserted:' >> modify_post_install.py
            echo "                result_lines.append('  # Expo modules and Xcode 16.4 compatibility fixes\\n')" >> modify_post_install.py
            echo "                result_lines.append('  installer.pods_project.targets.each do |target|\\n')" >> modify_post_install.py
            echo "                result_lines.append('    target.build_configurations.each do |config|\\n')" >> modify_post_install.py
            echo "                result_lines.append('      config.build_settings[\"SWIFT_VERSION\"] = \"5.0\"\\n')" >> modify_post_install.py
            echo "                result_lines.append('      config.build_settings[\"GCC_WARN_INHIBIT_ALL_WARNINGS\"] = \"YES\"\\n')" >> modify_post_install.py
            echo "                result_lines.append('      config.build_settings[\"CLANG_WARN_QUOTED_INCLUDE_IN_FRAMEWORK_HEADER\"] = \"NO\"\\n')" >> modify_post_install.py
            echo "                result_lines.append('      deployment_target = config.build_settings[\"IPHONEOS_DEPLOYMENT_TARGET\"]\\n')" >> modify_post_install.py
            echo "                result_lines.append('      if deployment_target.nil? || deployment_target.to_f < 18.5\\n')" >> modify_post_install.py
            echo "                result_lines.append('        config.build_settings[\"IPHONEOS_DEPLOYMENT_TARGET\"] = \"18.5\"\\n')" >> modify_post_install.py
            echo "                result_lines.append('      end\\n')" >> modify_post_install.py
            echo "                result_lines.append('      config.build_settings[\"CLANG_CXX_LANGUAGE_STANDARD\"] = \"c++20\"\\n')" >> modify_post_install.py
            echo "                result_lines.append('      config.build_settings[\"CLANG_CXX_LIBRARY\"] = \"libc++\"\\n')" >> modify_post_install.py
            echo "                result_lines.append('    end\\n')" >> modify_post_install.py
            echo "                result_lines.append('  end\\n')" >> modify_post_install.py
            echo '                inserted = True' >> modify_post_install.py
            echo '            if end_count == 1:' >> modify_post_install.py
            echo '                in_post_install = False' >> modify_post_install.py
            echo '    result_lines.append(line)' >> modify_post_install.py
            echo '' >> modify_post_install.py
            echo 'if not inserted:' >> modify_post_install.py
            echo '    print("⚠️  Could not find post_install block, appending new block")' >> modify_post_install.py
            echo "    result_lines.append('\\n# Post-install fixes\\n')" >> modify_post_install.py
            echo "    result_lines.append('post_install do |installer|\\n')" >> modify_post_install.py
            echo "    result_lines.append('  installer.pods_project.targets.each do |target|\\n')" >> modify_post_install.py
            echo "    result_lines.append('    target.build_configurations.each do |config|\\n')" >> modify_post_install.py
            echo "    result_lines.append('      config.build_settings[\"SWIFT_VERSION\"] = \"5.0\"\\n')" >> modify_post_install.py
            echo "    result_lines.append('      config.build_settings[\"GCC_WARN_INHIBIT_ALL_WARNINGS\"] = \"YES\"\\n')" >> modify_post_install.py
            echo "    result_lines.append('      config.build_settings[\"CLANG_WARN_QUOTED_INCLUDE_IN_FRAMEWORK_HEADER\"] = \"NO\"\\n')" >> modify_post_install.py
            echo "    result_lines.append('      deployment_target = config.build_settings[\"IPHONEOS_DEPLOYMENT_TARGET\"]\\n')" >> modify_post_install.py
            echo "    result_lines.append('      if deployment_target.nil? || deployment_target.to_f < 18.5\\n')" >> modify_post_install.py
            echo "    result_lines.append('        config.build_settings[\"IPHONEOS_DEPLOYMENT_TARGET\"] = \"18.5\"\\n')" >> modify_post_install.py
            echo "    result_lines.append('      end\\n')" >> modify_post_install.py
            echo "    result_lines.append('      config.build_settings[\"CLANG_CXX_LANGUAGE_STANDARD\"] = \"c++20\"\\n')" >> modify_post_install.py
            echo "    result_lines.append('      config.build_settings[\"CLANG_CXX_LIBRARY\"] = \"libc++\"\\n')" >> modify_post_install.py
            echo "    result_lines.append('    end\\n')" >> modify_post_install.py
            echo "    result_lines.append('  end\\n')" >> modify_post_install.py
            echo "    result_lines.append('end\\n')" >> modify_post_install.py
            echo 'else:' >> modify_post_install.py
            echo '    print("✅ Added fixes to existing post_install block")' >> modify_post_install.py
            echo '' >> modify_post_install.py
            echo 'with open("Podfile", "w") as f:' >> modify_post_install.py
            echo '    f.writelines(result_lines)' >> modify_post_install.py
            python3 modify_post_install.py
            rm modify_post_install.py
          else
            echo "No existing post_install block found, creating new one..."
            # Add Swift version and nullability fixes
            echo '' >> Podfile
            echo '# Post-install fixes for Expo modules and Xcode 16.4 compatibility' >> Podfile
            echo 'post_install do |installer|' >> Podfile
            echo '  installer.pods_project.targets.each do |target|' >> Podfile
            echo '    target.build_configurations.each do |config|' >> Podfile
            echo '      # Set Swift version to 5.0 (compatible with Xcode 16.4)' >> Podfile
            echo "      config.build_settings['SWIFT_VERSION'] = '5.0'" >> Podfile
            echo '      # Fix nullability warnings in Expo modules' >> Podfile
            echo "      config.build_settings['GCC_WARN_INHIBIT_ALL_WARNINGS'] = 'YES'" >> Podfile
            echo "      config.build_settings['CLANG_WARN_QUOTED_INCLUDE_IN_FRAMEWORK_HEADER'] = 'NO'" >> Podfile
            echo '      # Ensure proper deployment target' >> Podfile
            echo '      deployment_target = config.build_settings['"'"'IPHONEOS_DEPLOYMENT_TARGET'"'"']' >> Podfile
            echo '      if deployment_target.nil? || deployment_target.to_f < 18.5' >> Podfile
            echo "        config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '18.5'" >> Podfile
            echo '      end' >> Podfile
            echo '      # Fix for Objective-C++ compilation' >> Podfile
            echo "      config.build_settings['CLANG_CXX_LANGUAGE_STANDARD'] = 'c++20'" >> Podfile
            echo "      config.build_settings['CLANG_CXX_LIBRARY'] = 'libc++'" >> Podfile
            echo '    end' >> Podfile
            echo '  end' >> Podfile
            echo 'end' >> Podfile
          fi
          
          # Validate Podfile syntax
          echo "Validating Podfile syntax..."
          if ! ruby -c Podfile 2>/dev/null; then
            echo "⚠️  Podfile syntax check failed, but continuing..."
          else
            echo "✅ Podfile syntax is valid"
          fi
          
          # Validate Podfile syntax after modification
          echo ""
          echo "Validating Podfile syntax after modification..."
          if ruby -c Podfile; then
            echo "✅ Podfile syntax is valid"
          else
            echo "❌ ERROR: Podfile syntax is invalid!"
            echo "Podfile content (last 30 lines):"
            tail -30 Podfile
            exit 1
          fi
          
          echo ""
          echo "✅ Podfile updated with compatibility fixes"
          echo "Added fixes:"
          echo "- Swift version 5.0"
          echo "- Nullability warning suppressions"
          echo "- C++20 standard for Objective-C++"
          echo "- iOS 18.5 deployment target"
          echo ""
          echo "Podfile preview (last 20 lines):"
          tail -20 Podfile
          cd ..
      
      - name: Clean and install CocoaPods
        run: |
          echo "=== Cleaning and installing CocoaPods ==="
          cd ios
          
          # Clean previous builds thoroughly
          echo "Cleaning Pods..."
          rm -rf Pods Podfile.lock
          rm -rf build
          rm -rf ~/Library/Developer/Xcode/DerivedData/*
          rm -rf ~/Library/Caches/CocoaPods
          
          # Update CocoaPods repo
          echo "Updating CocoaPods repo..."
          pod repo update || true
          
          # Install pods with verbose output
          echo "Installing pods..."
          pod install --repo-update --verbose 2>&1 | tee pod_install.log || {
            echo "❌ Pod install failed!"
            echo "Last 100 lines of pod install log:"
            tail -100 pod_install.log
            exit 1
          }
          
          echo "✅ CocoaPods installed successfully"
          
          # Verify codegen files were generated
          echo ""
          echo "=== Verifying Codegen files after pod install ==="
          if [ -d "build/generated/ios" ]; then
            echo "✅ Codegen directory exists"
            GENERATED_COUNT=$(find build/generated/ios -name "*-generated.*" 2>/dev/null | wc -l | xargs)
            echo "Found $GENERATED_COUNT generated files"
            if [ "$GENERATED_COUNT" -eq 0 ]; then
              echo "⚠️  WARNING: No codegen files found! This may cause build failures."
              echo "Listing build/generated/ios contents:"
              ls -la build/generated/ios/ || echo "Directory is empty or doesn't exist"
            else
              echo "Sample generated files:"
              find build/generated/ios -name "*-generated.*" | head -10
            fi
          else
            echo "❌ ERROR: Codegen directory not found after pod install!"
            echo "This will cause build failures. Checking if build directory exists:"
            ls -la build/ 2>/dev/null || echo "build/ directory doesn't exist"
          fi
          
          cd ..
      
      - name: Setup Xcode
        run: |
          sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          xcodebuild -version
          echo ""
          echo "Xcode SDK paths:"
          xcrun --show-sdk-path --sdk iphoneos || true
          xcrun --show-sdk-path --sdk iphonesimulator || true
      
      - name: Setup Xcode Signing (Free Apple ID)
        run: |
          # Xcode will use automatic signing with free Apple ID
          # This requires manual setup in Xcode, but we'll try automatic
          echo "Setting up automatic code signing..."
      
      - name: Create build directory
        run: mkdir -p build
      
      - name: List iOS project structure
        run: |
          echo "=== iOS Project Structure ==="
          ls -la ios/ || echo "ios/ directory not found"
          ls -la ios/*.xcworkspace 2>/dev/null || echo "No .xcworkspace found"
          ls -la ios/*.xcodeproj 2>/dev/null || echo "No .xcodeproj found"
      
      - name: Verify Codegen files exist
        run: |
          echo "=== Verifying Codegen files before build ==="
          cd ios
          
          # Check if codegen files were generated
          if [ -d "build/generated/ios" ]; then
            echo "✅ Codegen directory exists"
            GENERATED_COUNT=$(find build/generated/ios -name "*-generated.*" 2>/dev/null | wc -l | xargs)
            echo "Found $GENERATED_COUNT generated files"
            
            echo ""
            echo "Checking for specific required files:"
            REQUIRED_FILES=(
              "build/generated/ios/safeareacontextJSI-generated.cpp"
              "build/generated/ios/safeareacontext/safeareacontext-generated.mm"
              "build/generated/ios/rnworkletsJSI-generated.cpp"
              "build/generated/ios/rnworklets/rnworklets-generated.mm"
              "build/generated/ios/rnsvgJSI-generated.cpp"
            )
            MISSING_COUNT=0
            for file in "${REQUIRED_FILES[@]}"; do
              if [ -f "$file" ]; then
                echo "✅ $file exists"
              else
                echo "❌ $file MISSING"
                MISSING_COUNT=$((MISSING_COUNT + 1))
              fi
            done
            
            if [ "$MISSING_COUNT" -gt 0 ]; then
              echo ""
              echo "⚠️  WARNING: $MISSING_COUNT required codegen files are missing!"
              echo "This may cause build failures. Listing all generated files:"
              find build/generated/ios -name "*-generated.*" | head -20
            fi
          else
            echo "❌ ERROR: Codegen directory not found!"
            echo "This will cause build failures."
            echo "Checking if build directory exists:"
            ls -la build/ 2>/dev/null || echo "build/ directory doesn't exist"
            exit 1
          fi
          cd ..
      
      - name: Discover scheme name
        id: scheme
        run: |
          echo "=== Discovering Scheme Name ==="
          # Try to find workspace first
          WORKSPACE=$(find ios -name "*.xcworkspace" -type d | head -n 1)
          if [ -z "$WORKSPACE" ]; then
            # Fall back to xcodeproj
            PROJECT=$(find ios -name "*.xcodeproj" -type d | head -n 1)
            if [ -z "$PROJECT" ]; then
              echo "ERROR: No workspace or project found!"
              exit 1
            fi
            echo "Found project: $PROJECT"
            SCHEME=$(xcodebuild -list -project "$PROJECT" | grep -A 100 "Schemes:" | grep -v "Schemes:" | head -n 1 | xargs)
          else
            echo "Found workspace: $WORKSPACE"
            SCHEME=$(xcodebuild -list -workspace "$WORKSPACE" | grep -A 100 "Schemes:" | grep -v "Schemes:" | head -n 1 | xargs)
          fi
          
          if [ -z "$SCHEME" ]; then
            # Default to app name from app.json
            SCHEME="WorkoutTracker"
            echo "Using default scheme: $SCHEME"
          else
            echo "Discovered scheme: $SCHEME"
          fi
          
          echo "scheme=$SCHEME" >> $GITHUB_OUTPUT
          echo "workspace=$WORKSPACE" >> $GITHUB_OUTPUT
      
      - name: Verify Codegen files exist
        run: |
          echo "=== Verifying Codegen files ==="
          cd ios
          
          # Check if codegen files were generated
          if [ -d "build/generated/ios" ]; then
            echo "✅ Codegen directory exists"
            echo "Codegen files found:"
            find build/generated/ios -name "*-generated.*" | head -20 || echo "No generated files found"
            echo ""
            echo "Checking for specific required files:"
            REQUIRED_FILES=(
              "build/generated/ios/safeareacontextJSI-generated.cpp"
              "build/generated/ios/safeareacontext/safeareacontext-generated.mm"
              "build/generated/ios/rnworkletsJSI-generated.cpp"
              "build/generated/ios/rnworklets/rnworklets-generated.mm"
              "build/generated/ios/rnsvgJSI-generated.cpp"
            )
            for file in "${REQUIRED_FILES[@]}"; do
              if [ -f "$file" ]; then
                echo "✅ $file exists"
              else
                echo "❌ $file MISSING"
              fi
            done
          else
            echo "❌ Codegen directory not found!"
            echo "Running codegen manually..."
            # Try to run codegen manually
            cd ..
            npx react-native codegen --path ios || echo "Manual codegen failed, continuing..."
            cd ios
          fi
          cd ..
      
      - name: Clean Xcode build folder (preserve codegen)
        run: |
          echo "=== Cleaning Xcode build folder (preserving codegen) ==="
          cd ios
          # Only clean build artifacts, not codegen files
          if [ -d "build" ]; then
            # Preserve generated codegen files
            if [ -d "build/generated" ]; then
              echo "Preserving codegen files..."
              mkdir -p /tmp/codegen_backup
              cp -R build/generated /tmp/codegen_backup/ || true
            fi
            # Remove other build artifacts but keep generated folder
            find build -mindepth 1 -maxdepth 1 ! -name "generated" -exec rm -rf {} + || true
            # Restore codegen if it was backed up
            if [ -d "/tmp/codegen_backup/generated" ]; then
              cp -R /tmp/codegen_backup/generated build/ || true
              rm -rf /tmp/codegen_backup
            fi
            echo "✅ Cleaned build artifacts (preserved codegen)"
          fi
          # Clean derived data
          rm -rf ~/Library/Developer/Xcode/DerivedData/*
          echo "✅ Cleaned Xcode derived data"
          cd ..
      
      - name: Build iOS app
        run: |
          set -e  # Exit on error
          echo "=== Starting iOS Build ==="
          
          SCHEME="${{ steps.scheme.outputs.scheme }}"
          WORKSPACE="${{ steps.scheme.outputs.workspace }}"
          
          if [ -z "$WORKSPACE" ]; then
            WORKSPACE="ios/WorkoutTracker.xcworkspace"
          fi
          
          # Check if workspace exists
          if [ ! -d "$WORKSPACE" ] && [ ! -d "${WORKSPACE%.xcworkspace}.xcodeproj" ]; then
            echo "ERROR: Workspace/Project not found: $WORKSPACE"
            ls -la ios/
            exit 1
          fi
          
          echo "Building with scheme: $SCHEME"
          echo "Using workspace: $WORKSPACE"
          
          # Determine SDK path
          SDK_PATH=$(xcrun --show-sdk-path --sdk iphoneos)
          echo "Using SDK: $SDK_PATH"
          echo "Xcode version:"
          xcodebuild -version
          
          # Step 1: Build the app first (not archive) to verify compilation succeeds
          echo "Step 1: Building app to verify compilation..."
          BUILD_SUCCESS=false
          BUILD_LOG="build.log"
          
          # Build with better error capture
          if [[ "$WORKSPACE" == *.xcworkspace ]]; then
            echo "Building with workspace..."
            set +e  # Don't exit on error, we'll check manually
            xcodebuild -workspace "$WORKSPACE" \
              -scheme "$SCHEME" \
              -configuration Release \
              -sdk iphoneos \
              -destination "generic/platform=iOS" \
              -allowProvisioningUpdates \
              DEVELOPMENT_TEAM="" \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_ALLOWED=NO \
              build 2>&1 | tee "$BUILD_LOG"
            BUILD_EXIT_CODE=${PIPESTATUS[0]}
            set -e
          else
            echo "Building with project..."
            set +e
            xcodebuild -project "${WORKSPACE%.xcworkspace}.xcodeproj" \
              -scheme "$SCHEME" \
              -configuration Release \
              -sdk iphoneos \
              -destination "generic/platform=iOS" \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_ALLOWED=NO \
              build 2>&1 | tee "$BUILD_LOG"
            BUILD_EXIT_CODE=${PIPESTATUS[0]}
            set -e
          fi
          
          # Check if build actually succeeded AND that the app was built
          if [ "$BUILD_EXIT_CODE" -eq 0 ] && grep -q "BUILD SUCCEEDED" "$BUILD_LOG"; then
            # Verify the app target was actually built (not just Pods)
            if grep -q "Building.*$SCHEME\|Compiling.*$SCHEME\|Linking.*$SCHEME\|Touch.*$SCHEME.app\|Copying.*$SCHEME.app" "$BUILD_LOG"; then
              echo "✅ Build succeeded and app target was built!"
              BUILD_SUCCESS=true
            else
              echo "⚠️  BUILD SUCCEEDED but app target may not have been built (only Pods?)"
              echo "Checking build log for app target..."
              grep -i "$SCHEME" "$BUILD_LOG" | tail -20 || echo "No app target found in log"
              BUILD_SUCCESS=false
            fi
          else
            echo "❌ Build failed (exit code: $BUILD_EXIT_CODE)"
            BUILD_SUCCESS=false
          fi
          
          # Analyze build log for errors
          if [ "$BUILD_SUCCESS" = false ]; then
            echo ""
            echo "❌ ERROR: Build failed!"
            echo ""
            echo "=== Build Log Analysis ==="
            echo "Exit code: $BUILD_EXIT_CODE"
            echo ""
            
            if [ -f "$BUILD_LOG" ]; then
              echo "--- Actual compilation errors (filtered) ---"
              # Filter out environment variables and show actual errors
              grep -E "error:|Error:|ERROR|failed|Failed|FAILED|undefined|missing|not found" "$BUILD_LOG" | \
                grep -v "export " | \
                grep -v "BUILD_DIR=" | \
                grep -v "SDKROOT=" | \
                grep -v "ARCHS=" | \
                tail -100 || echo "No filtered errors found"
              echo ""
              echo "--- All error lines (last 150) ---"
              grep -i "error" "$BUILD_LOG" | tail -150 || echo "No error lines found"
              echo ""
              echo "--- Failed commands ---"
              grep -i "failed\|FAILED" "$BUILD_LOG" | tail -50 || echo "No failed commands found"
              echo ""
              echo "--- Missing files/undefined symbols ---"
              grep -i "missing\|undefined\|not found\|No such file" "$BUILD_LOG" | tail -50 || echo "No missing file errors found"
              echo ""
              echo "--- Last 500 lines of build log (raw) ---"
              tail -500 "$BUILD_LOG"
            else
              echo "Build log file not found!"
            fi
            exit 1
          fi
          
          # Step 2: Verify app bundle was created in derived data
          echo ""
          echo "Step 2: Verifying app bundle was created..."
          
          # Extract build output path from build log
          echo "Extracting build output path from build log..."
          BUILD_PRODUCTS_DIR=$(grep -o "BUILT_PRODUCTS_DIR=[^ ]*" "$BUILD_LOG" | head -1 | cut -d= -f2 | tr -d '"' || echo "")
          TARGET_BUILD_DIR=$(grep -o "TARGET_BUILD_DIR=[^ ]*" "$BUILD_LOG" | head -1 | cut -d= -f2 | tr -d '"' || echo "")
          
          if [ -n "$BUILD_PRODUCTS_DIR" ]; then
            echo "Found BUILT_PRODUCTS_DIR: $BUILD_PRODUCTS_DIR"
          fi
          if [ -n "$TARGET_BUILD_DIR" ]; then
            echo "Found TARGET_BUILD_DIR: $TARGET_BUILD_DIR"
          fi
          
          # Search in multiple locations with comprehensive patterns
          echo ""
          echo "Searching for app bundle..."
          
          # 1. Search by scheme name
          APP_BUNDLE=$(find ~/Library/Developer/Xcode/DerivedData -name "${SCHEME}.app" -type d 2>/dev/null | head -n 1)
          
          # 2. Search in explicit build products directories from log
          if [ -z "$APP_BUNDLE" ] && [ -n "$BUILD_PRODUCTS_DIR" ]; then
            APP_BUNDLE=$(find "$BUILD_PRODUCTS_DIR" -name "*.app" -type d 2>/dev/null | head -n 1)
          fi
          
          if [ -z "$APP_BUNDLE" ] && [ -n "$TARGET_BUILD_DIR" ]; then
            APP_BUNDLE=$(find "$TARGET_BUILD_DIR" -name "*.app" -type d 2>/dev/null | head -n 1)
          fi
          
          # 3. Search in Products directory with Release-iphoneos
          if [ -z "$APP_BUNDLE" ]; then
            APP_BUNDLE=$(find ~/Library/Developer/Xcode/DerivedData -path "*/Build/Products/Release-iphoneos/*.app" -type d 2>/dev/null | head -n 1)
          fi
          
          # 4. Search in any Products directory
          if [ -z "$APP_BUNDLE" ]; then
            APP_BUNDLE=$(find ~/Library/Developer/Xcode/DerivedData -path "*/Build/Products/*/*.app" -type d 2>/dev/null | head -n 1)
          fi
          
          # 5. Search in ios/build directory
          if [ -z "$APP_BUNDLE" ]; then
            APP_BUNDLE=$(find ios/build -name "*.app" -type d 2>/dev/null | head -n 1)
          fi
          
          # 6. Search for ANY .app file in derived data (might have different name)
          if [ -z "$APP_BUNDLE" ]; then
            echo "Searching for any .app files in derived data..."
            ALL_APP_FILES=$(find ~/Library/Developer/Xcode/DerivedData -name "*.app" -type d 2>/dev/null | grep -v "Pods\|\.framework" | head -5)
            if [ -n "$ALL_APP_FILES" ]; then
              echo "Found .app files (excluding Pods/frameworks):"
              echo "$ALL_APP_FILES"
              APP_BUNDLE=$(echo "$ALL_APP_FILES" | head -n 1)
            fi
          fi
          
          # 7. Check build log for actual output path
          if [ -z "$APP_BUNDLE" ]; then
            echo "Checking build log for app bundle output path..."
            APP_OUTPUT=$(grep -i "touch.*\.app\|copy.*\.app\|built.*\.app" "$BUILD_LOG" | grep -v "Pods\|framework" | head -1 || echo "")
            if [ -n "$APP_OUTPUT" ]; then
              echo "Found app output reference in log: $APP_OUTPUT"
              # Try to extract path
              APP_PATH=$(echo "$APP_OUTPUT" | grep -o "/[^ ]*\.app" | head -1 || echo "")
              if [ -n "$APP_PATH" ] && [ -d "$APP_PATH" ]; then
                APP_BUNDLE="$APP_PATH"
              fi
            fi
          fi
          
          if [ -z "$APP_BUNDLE" ]; then
            echo "❌ ERROR: App bundle not found after comprehensive search!"
            echo ""
            echo "=== Comprehensive Search Results ==="
            echo ""
            echo "1. All .app files in DerivedData (excluding Pods/frameworks):"
            find ~/Library/Developer/Xcode/DerivedData -name "*.app" -type d 2>/dev/null | grep -v "Pods\|\.framework" | head -20 || echo "None found"
            echo ""
            echo "2. Build log references to .app files:"
            grep -i "\.app" "$BUILD_LOG" | grep -v "Pods\|framework\|note:" | tail -20 || echo "None found"
            echo ""
            echo "3. Build output directories from log:"
            grep -E "BUILT_PRODUCTS_DIR|TARGET_BUILD_DIR|CONFIGURATION_BUILD_DIR" "$BUILD_LOG" | head -5 || echo "None found"
            echo ""
            echo "4. App target build phases from log:"
            grep -i "touch\|copy\|built" "$BUILD_LOG" | grep -i "$SCHEME" | tail -10 || echo "None found"
            echo ""
            echo "Build log shows BUILD SUCCEEDED and app target was built, but app bundle is missing."
            echo "This might indicate the app bundle is being created with a different name or in an unexpected location."
            exit 1
          else
            echo "✅ Found app bundle: $APP_BUNDLE"
            echo "App bundle size: $(du -sh "$APP_BUNDLE" | cut -f1)"
          fi
          
          # Step 3: Create archive
          echo ""
          echo "Step 3: Creating archive..."
          if [[ "$WORKSPACE" == *.xcworkspace ]]; then
            xcodebuild -workspace "$WORKSPACE" \
              -scheme "$SCHEME" \
              -configuration Release \
              -sdk iphoneos \
              -archivePath build/WorkoutTracker.xcarchive \
              -allowProvisioningUpdates \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_ALLOWED=NO \
              archive 2>&1 | tee archive.log || {
                echo "❌ Archive failed!"
                tail -100 archive.log
                exit 1
              }
          else
            xcodebuild -project "${WORKSPACE%.xcworkspace}.xcodeproj" \
              -scheme "$SCHEME" \
              -configuration Release \
              -sdk iphoneos \
              -archivePath build/WorkoutTracker.xcarchive \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_ALLOWED=NO \
              archive 2>&1 | tee archive.log || {
                echo "❌ Archive failed!"
                tail -100 archive.log
                exit 1
              }
          fi
          
          echo "=== Archive Created ==="
          echo "Archive contents:"
          ls -la build/WorkoutTracker.xcarchive/ || true
          
          # Verify archive contains app bundle
          ARCHIVE_APP_BUNDLE=$(find build/WorkoutTracker.xcarchive -name "*.app" -type d | head -n 1)
          if [ -z "$ARCHIVE_APP_BUNDLE" ]; then
            echo "❌ ERROR: No app bundle found in archive!"
            echo "Checking archive structure:"
            find build/WorkoutTracker.xcarchive -type f -o -type d | head -30
            echo ""
            echo "Checking Products directory:"
            ls -la build/WorkoutTracker.xcarchive/Products/ || true
            echo ""
            echo "This should not happen if build succeeded. Checking if app bundle exists elsewhere:"
            find build -name "*.app" -type d || echo "No .app files found in build/"
            exit 1
          else
            echo "✅ Found app bundle in archive: $ARCHIVE_APP_BUNDLE"
          fi
      
      - name: Export IPA (Development for Free Apple ID)
        run: |
          set -e  # Exit on error
          echo "=== Starting IPA Export ==="
          
          ARCHIVE_PATH="build/WorkoutTracker.xcarchive"
          
          # Verify archive exists
          if [ ! -d "$ARCHIVE_PATH" ]; then
            echo "ERROR: Archive not found!"
            ls -la build/
            exit 1
          fi
          
          # Find the app bundle in the archive
          APP_BUNDLE=$(find "$ARCHIVE_PATH" -name "*.app" -type d | head -n 1)
          if [ -z "$APP_BUNDLE" ]; then
            echo "ERROR: No app bundle found in archive!"
            echo "Archive structure:"
            find "$ARCHIVE_PATH" -type f -o -type d | head -30
            echo ""
            echo "Products directory:"
            ls -la "$ARCHIVE_PATH/Products/" || true
            exit 1
          fi
          
          APP_NAME=$(basename "$APP_BUNDLE" .app)
          echo "Found app bundle: $APP_BUNDLE"
          echo "App name: $APP_NAME"
          
          # Try xcodebuild export first (for signed builds)
          cat > exportOptions.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>development</string>
            <key>signingStyle</key>
            <string>automatic</string>
          </dict>
          </plist>
          EOF
          
          # Try xcodebuild export
          if xcodebuild -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportPath build \
            -exportOptionsPlist exportOptions.plist 2>&1 | tee export.log; then
            echo "✅ Export succeeded via xcodebuild"
          else
            echo "⚠️  xcodebuild export failed (this is OK for unsigned builds)"
            echo "Creating IPA manually from app bundle..."
            
            # Create IPA manually (works for both signed and unsigned)
            mkdir -p build/Payload
            cp -R "$APP_BUNDLE" "build/Payload/$APP_NAME.app"
            
            # Remove any existing IPA
            rm -f "build/${APP_NAME}.ipa"
            
            # Create IPA
            cd build
            zip -r "${APP_NAME}.ipa" Payload
            cd ..
            
            # Cleanup
            rm -rf build/Payload
            
            echo "✅ IPA created manually: build/${APP_NAME}.ipa"
          fi
          
          # Verify IPA was created
          echo ""
          echo "=== Export Complete ==="
          echo "Build directory contents:"
          ls -lah build/ | grep -E "\.(ipa|xcarchive)" || ls -lah build/
          
          IPA_FILE=$(find build -name "*.ipa" -type f | head -n 1)
          if [ -z "$IPA_FILE" ]; then
            echo "❌ ERROR: No IPA file found!"
            exit 1
          else
            echo "✅ IPA file found: $IPA_FILE"
            echo "File size: $(du -h "$IPA_FILE" | cut -f1)"
          fi
      
      - name: Check for IPA file
        run: |
          echo "=== Checking for IPA files ==="
          find build -name "*.ipa" -type f || echo "No IPA files found in build/"
          ls -la build/ || echo "build/ directory doesn't exist"
      
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        if: always()  # Upload even if previous steps failed
        with:
          name: ios-build
          path: |
            build/*.ipa
            build/*.xcarchive
          if-no-files-found: warn
      
      - name: Upload IPA to release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: build/*.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

