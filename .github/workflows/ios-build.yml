name: Build iOS App (Free Mac Runner)

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build-ios:
    runs-on: macos-latest  # FREE Mac runner from GitHub!
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm install
      
      - name: Generate native project
        run: npx expo prebuild --platform ios
      
      - name: Setup Xcode
        run: |
          sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          xcodebuild -version
      
      - name: Setup Xcode Signing (Free Apple ID)
        run: |
          # Xcode will use automatic signing with free Apple ID
          # This requires manual setup in Xcode, but we'll try automatic
          echo "Setting up automatic code signing..."
      
      - name: Create build directory
        run: mkdir -p build
      
      - name: List iOS project structure
        run: |
          echo "=== iOS Project Structure ==="
          ls -la ios/ || echo "ios/ directory not found"
          ls -la ios/*.xcworkspace 2>/dev/null || echo "No .xcworkspace found"
          ls -la ios/*.xcodeproj 2>/dev/null || echo "No .xcodeproj found"
      
      - name: Discover scheme name
        id: scheme
        run: |
          echo "=== Discovering Scheme Name ==="
          # Try to find workspace first
          WORKSPACE=$(find ios -name "*.xcworkspace" -type d | head -n 1)
          if [ -z "$WORKSPACE" ]; then
            # Fall back to xcodeproj
            PROJECT=$(find ios -name "*.xcodeproj" -type d | head -n 1)
            if [ -z "$PROJECT" ]; then
              echo "ERROR: No workspace or project found!"
              exit 1
            fi
            echo "Found project: $PROJECT"
            SCHEME=$(xcodebuild -list -project "$PROJECT" | grep -A 100 "Schemes:" | grep -v "Schemes:" | head -n 1 | xargs)
          else
            echo "Found workspace: $WORKSPACE"
            SCHEME=$(xcodebuild -list -workspace "$WORKSPACE" | grep -A 100 "Schemes:" | grep -v "Schemes:" | head -n 1 | xargs)
          fi
          
          if [ -z "$SCHEME" ]; then
            # Default to app name from app.json
            SCHEME="WorkoutTracker"
            echo "Using default scheme: $SCHEME"
          else
            echo "Discovered scheme: $SCHEME"
          fi
          
          echo "scheme=$SCHEME" >> $GITHUB_OUTPUT
          echo "workspace=$WORKSPACE" >> $GITHUB_OUTPUT
      
      - name: Build iOS app
        run: |
          set -e  # Exit on error
          echo "=== Starting iOS Build ==="
          
          SCHEME="${{ steps.scheme.outputs.scheme }}"
          WORKSPACE="${{ steps.scheme.outputs.workspace }}"
          
          if [ -z "$WORKSPACE" ]; then
            WORKSPACE="ios/WorkoutTracker.xcworkspace"
          fi
          
          # Check if workspace exists
          if [ ! -d "$WORKSPACE" ] && [ ! -d "${WORKSPACE%.xcworkspace}.xcodeproj" ]; then
            echo "ERROR: Workspace/Project not found: $WORKSPACE"
            ls -la ios/
            exit 1
          fi
          
          echo "Building with scheme: $SCHEME"
          echo "Using workspace: $WORKSPACE"
          
          # Build archive - try with automatic signing first
          if [[ "$WORKSPACE" == *.xcworkspace ]]; then
            xcodebuild -workspace "$WORKSPACE" \
              -scheme "$SCHEME" \
              -configuration Release \
              -archivePath build/WorkoutTracker.xcarchive \
              -allowProvisioningUpdates \
              CODE_SIGN_IDENTITY="Apple Development" \
              CODE_SIGN_STYLE="Automatic" \
              archive || {
                echo "Build with automatic signing failed, trying without signing..."
                xcodebuild -workspace "$WORKSPACE" \
                  -scheme "$SCHEME" \
                  -configuration Release \
                  -archivePath build/WorkoutTracker.xcarchive \
                  CODE_SIGN_IDENTITY="" \
                  CODE_SIGNING_ALLOWED=NO \
                  archive
              }
          else
            xcodebuild -project "${WORKSPACE%.xcworkspace}.xcodeproj" \
              -scheme "$SCHEME" \
              -configuration Release \
              -archivePath build/WorkoutTracker.xcarchive \
              -allowProvisioningUpdates \
              CODE_SIGN_IDENTITY="Apple Development" \
              CODE_SIGN_STYLE="Automatic" \
              archive || {
                echo "Build with automatic signing failed, trying without signing..."
                xcodebuild -project "${WORKSPACE%.xcworkspace}.xcodeproj" \
                  -scheme "$SCHEME" \
                  -configuration Release \
                  -archivePath build/WorkoutTracker.xcarchive \
                  CODE_SIGN_IDENTITY="" \
                  CODE_SIGNING_ALLOWED=NO \
                  archive
              }
          fi
          
          echo "=== Build Complete ==="
          ls -la build/
      
      - name: Inspect Archive Structure
        run: |
          echo "=== Inspecting Archive Structure ==="
          ARCHIVE_PATH="build/WorkoutTracker.xcarchive"
          if [ -d "$ARCHIVE_PATH" ]; then
            echo "Archive found at: $ARCHIVE_PATH"
            echo "Contents:"
            ls -la "$ARCHIVE_PATH" || true
            echo ""
            echo "Products directory:"
            ls -la "$ARCHIVE_PATH/Products" || true
            echo ""
            echo "Applications directory:"
            find "$ARCHIVE_PATH" -type d -name "Applications" -exec ls -la {} \; || true
            echo ""
            echo "App bundles:"
            find "$ARCHIVE_PATH" -name "*.app" -type d || echo "No .app bundles found"
          else
            echo "ERROR: Archive not found!"
            ls -la build/
          fi
      
      - name: Export IPA (Development for Free Apple ID)
        run: |
          set -e  # Exit on error
          echo "=== Starting IPA Export ==="
          
          # Check if archive exists
          ARCHIVE_PATH="build/WorkoutTracker.xcarchive"
          if [ ! -d "$ARCHIVE_PATH" ]; then
            echo "ERROR: Archive not found!"
            ls -la build/
            exit 1
          fi
          
          # Find the app bundle in the archive
          APP_BUNDLE=$(find "$ARCHIVE_PATH" -name "*.app" -type d | head -n 1)
          if [ -z "$APP_BUNDLE" ]; then
            echo "ERROR: No app bundle found in archive!"
            echo "Archive structure:"
            find "$ARCHIVE_PATH" -type f -o -type d | head -20
            exit 1
          fi
          
          echo "Found app bundle: $APP_BUNDLE"
          
          # Try export with development method first
          cat > exportOptions.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>development</string>
            <key>signingStyle</key>
            <string>automatic</string>
          </dict>
          </plist>
          EOF
          
          # Try export - if it fails, create IPA manually
          if xcodebuild -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportPath build \
            -exportOptionsPlist exportOptions.plist 2>&1; then
            echo "Export succeeded via xcodebuild"
          else
            echo "xcodebuild export failed, creating IPA manually..."
            # Extract app bundle name
            APP_NAME=$(basename "$APP_BUNDLE" .app)
            echo "App name: $APP_NAME"
            
            # Create IPA manually
            mkdir -p build/Payload
            cp -R "$APP_BUNDLE" "build/Payload/$APP_NAME.app"
            cd build
            zip -r "${APP_NAME}.ipa" Payload
            cd ..
            rm -rf build/Payload
            echo "IPA created manually: build/${APP_NAME}.ipa"
          fi
          
          echo "=== Export Complete ==="
          ls -la build/
          find build -name "*.ipa" -type f || echo "WARNING: No IPA file found!"
      
      - name: Check for IPA file
        run: |
          echo "=== Checking for IPA files ==="
          find build -name "*.ipa" -type f || echo "No IPA files found in build/"
          ls -la build/ || echo "build/ directory doesn't exist"
      
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        if: always()  # Upload even if previous steps failed
        with:
          name: ios-build
          path: |
            build/*.ipa
            build/*.xcarchive
          if-no-files-found: warn
      
      - name: Upload IPA to release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: build/*.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

